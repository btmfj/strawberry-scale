<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7Seg OCR Adjuster</title>
    <script src="https://unpkg.com/tesseract.js@v4.1.0/dist/tesseract.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #222; color: #ddd; margin: 0; padding: 20px; }
        #container { position: relative; display: inline-block; background: #000; }
        video { border: 1px solid #444; max-width: 100%; height: auto; }
        #guide {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 240px; height: 100px;
            border: 2px solid #0f0; box-shadow: 0 0 15px rgba(0,255,0,0.5);
            pointer-events: none;
        }
        .controls { background: #333; padding: 15px; border-radius: 8px; margin: 15px auto; max-width: 500px; text-align: left; }
        .control-group { margin-bottom: 10px; display: flex; align-items: center; justify-content: space-between; }
        canvas { border: 1px solid #fff; background: #000; margin-top: 10px; width: 240px; height: 100px; }
        #result { font-size: 2.5rem; font-weight: bold; color: #00ff00; text-shadow: 0 0 10px #00ff00; margin: 10px 0; }
        button { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; font-size: 1rem; width: 100%; }
        button:active { background: #0056b3; }
    </style>
</head>
<body>

    <h2>秤デジタル数字 OCR調整</h2>
    
    <div id="container">
        <video id="video" autoplay playsinline></video>
        <div id="guide"></div>
    </div>

    <div class="controls">
        <div class="control-group">
            <label>しきい値 (Threshold): <span id="thresh-val">128</span></label>
            <input type="range" id="threshold" min="0" max="255" value="128" style="width: 200px;">
        </div>
        <div class="control-group">
            <label>白黒反転 (Invert):</label>
            <input type="checkbox" id="invert">
        </div>
        <button id="capture-btn">スキャン実行</button>
    </div>

    <div>
        <p>OCR用解析画像（プレビュー）:</p>
        <canvas id="canvas"></canvas>
    </div>

    <div id="result">結果: ---</div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const resultDiv = document.getElementById('result');
        const captureBtn = document.getElementById('capture-btn');
        const threshInput = document.getElementById('threshold');
        const threshVal = document.getElementById('thresh-val');
        const invertCheck = document.getElementById('invert');

        // 1. カメラの起動
        navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } 
        })
        .then(stream => { video.srcObject = stream; })
        .catch(err => alert("カメラを許可してください: " + err));

        // 2. リアルタイム・プレビュー処理
        function processFrame() {
            if (video.paused || video.ended) return;

            const ctx = canvas.getContext('2d', { willReadFrequently: true });
            
            // ビデオの実際のサイズと表示サイズの比率を計算
            const scaleX = video.videoWidth / video.clientWidth;
            const scaleY = video.videoHeight / video.clientHeight;
            
            const w = 240 * scaleX;
            const h = 100 * scaleY;
            const x = (video.videoWidth - w) / 2;
            const y = (video.videoHeight - h) / 2;

            canvas.width = 240;
            canvas.height = 100;
            
            // ガイド枠の部分を切り出し
            ctx.drawImage(video, x, y, w, h, 0, 0, 240, 100);

            // 二値化処理
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            const threshold = parseInt(threshInput.value);
            const isInverted = invertCheck.checked;

            for (let i = 0; i < data.length; i += 4) {
                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                let val = avg >= threshold ? 255 : 0;
                
                if (isInverted) val = 255 - val; // 反転

                data[i] = data[i + 1] = data[i + 2] = val;
            }
            ctx.putImageData(imageData, 0, 0);

            requestAnimationFrame(processFrame);
        }

        video.addEventListener('play', processFrame);

        // スライダーの値表示更新
        threshInput.addEventListener('input', () => {
            threshVal.innerText = threshInput.value;
        });

        // 3. OCR実行
        captureBtn.addEventListener('click', async () => {
            resultDiv.innerText = "解析中...";
            resultDiv.style.color = "#ffaa00";

            try {
                const { data: { text } } = await Tesseract.recognize(canvas, 'eng', {
                    tessedit_char_whitelist: '0123456789.',
                    // 7セグ認識精度向上のためのパラメータ
                    tessedit_pageseg_mode: '7' // Single line of text
                });

                const cleanText = text.replace(/\s/g, '');
                resultDiv.innerText = cleanText ? `V ${cleanText}` : "読取失敗";
                resultDiv.style.color = "#00ff00";
            } catch (e) {
                resultDiv.innerText = "エラー発生";
                console.error(e);
            }
        });
    </script>
</body>
</html>
