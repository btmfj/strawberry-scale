<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7Seg OCR Prototype</title>
    <script src="https://unpkg.com/tesseract.js@v4.1.0/dist/tesseract.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; background: #f0f0f0; }
        #container { position: relative; display: inline-block; }
        video, canvas { border: 2px solid #333; border-radius: 8px; max-width: 100%; }
        #guide {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 200px; height: 80px;
            border: 3px solid #00ff00; box-shadow: 0 0 10px rgba(0,0,0,0.5);
            pointer-events: none;
        }
        .controls { margin: 20px; }
        #result { font-size: 2rem; font-weight: bold; color: #007bff; margin-top: 10px; }
    </style>
</head>
<body>

    <h1>秤デジタル数字読み取り (Wasm)</h1>
    
    <div id="container">
        <video id="video" autoplay playsinline></video>
        <div id="guide"></div>
    </div>

    <div class="controls">
        <button id="capture-btn" style="padding: 10px 20px; font-size: 1.2rem;">読み取り実行</button>
    </div>

    <div>
        <p>解析画像（二値化済み）:</p>
        <canvas id="canvas"></canvas>
    </div>

    <div id="result">結果: ---</div>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const resultDiv = document.getElementById('result');
        const captureBtn = document.getElementById('capture-btn');

        // 1. カメラの起動
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(stream => { video.srcObject = stream; })
            .catch(err => console.error("カメラ起動エラー:", err));

        // 2. 画像の前処理（二値化）
        function preprocessImage(ctx, width, height) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            for (let i = 0; i < data.length; i += 4) {
                // グレースケール化
                const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
                // 二値化（しきい値128：状況に合わせて調整）
                const val = avg > 128 ? 255 : 0;
                data[i] = data[i + 1] = data[i + 2] = val;
            }
            ctx.putImageData(imageData, 0, 0);
        }

        // 3. OCR実行
        captureBtn.addEventListener('click', async () => {
            resultDiv.innerText = "解析中...";
            
            // ガイド枠の部分だけを切り出してCanvasに描画
            const ctx = canvas.getContext('2d');
            const scale = video.videoWidth / video.clientWidth;
            const w = 200 * scale;
            const h = 80 * scale;
            const x = (video.videoWidth - w) / 2;
            const y = (video.videoHeight - h) / 2;

            canvas.width = 200;
            canvas.height = 80;
            ctx.drawImage(video, x, y, w, h, 0, 0, 200, 80);

            // 前処理実行
            preprocessImage(ctx, 200, 80);

            // Tesseract.jsで解析（数字のみに制限）
            const { data: { text } } = await Tesseract.recognize(canvas, 'eng', {
                tessedit_char_whitelist: '0123456789.',
            });

            resultDiv.innerText = `結果: ${text.trim() || "読取失敗"}`;
        });
    </script>
</body>
</html>
