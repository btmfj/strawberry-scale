// --- 修正・追加部分 ---
const SERVER_URL = "https://xxxx-xxxx.ngrok.io"; // Colabで表示されたURLに書き換えてください
let isProcessing = false; // 通信中の重複送信防止

async function sendImageToServer(base64Image) {
    if (isProcessing) return;
    isProcessing = true;

    try {
        const response = await fetch(`${SERVER_URL}/predict`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ image: base64Image })
        });
        const data = await response.json();

        if (data.success && data.digit) {
            const num = parseFloat(data.digit);
            if (!isNaN(num)) {
                weightDiv.innerText = num.toFixed(1);
                checkWeightDiff(num); // 既存の重量差チェックロジックへ
            }
        }
    } catch (error) {
        console.error("サーバー通信エラー:", error);
    } finally {
        isProcessing = false;
    }
}

// 既存のloop()関数内を書き換え
function loop() {
    if (video.paused || video.ended) return;
    const ctx = canvas.getContext('2d', { willReadFrequently: true });
    
    // クロップ処理（既存と同じ）
    canvas.width = 300; canvas.height = 120;
    const scale = video.videoWidth / video.clientWidth;
    const sw = 300 * scale; const sh = 120 * scale;
    const sx = (video.videoWidth - sw) / 2; const sy = (video.videoHeight - sh) / 2;
    ctx.drawImage(video, sx, sy, sw, sh, 0, 0, 300, 120);

    // 画像をサーバーへ送信（0.5秒おきなど間隔を空けると安定します）
    const base64Image = canvas.toDataURL('image/png');
    sendImageToServer(base64Image);

    requestAnimationFrame(loop);
}
